version: 1.0

runtime: python311

build:
  commands:
    build:
      - echo "[build] Building app"

run:
  runtime-version: 3.11
  pre-run:
    - echo "[build] Building app"
    - echo "[build] Installing pip"
    - pip3 install --upgrade pip
    - echo "[build] Installing poetry"
    - pip3 install "poetry==2.2.1"
    - echo "[build] Configuring poetry"
    - poetry config virtualenvs.create false
    - echo "[build] Installing app deps"
    - poetry install --no-root --no-ansi
    - echo "[build] App deps installed"
  command: poetry run uvicorn api.main:app --host 0.0.0.0 --port 8000
  network:
    port: 8000
  secrets:
    - name: SUPABASE_URL
      value-from: "arn:aws:secretsmanager:us-east-2:442707283978:secret:deal-deck-api/supabase-url"
    - name: SUPABASE_ANON_KEY
      value-from: "arn:aws:secretsmanager:us-east-2:442707283978:secret:deal-deck-api/supabase-anon-key"
    - name: SUPABASE_SERVICE_ROLE_KEY
      value-from: "arn:aws:secretsmanager:us-east-2:442707283978:secret:deal-deck-api/supabase-service-role-key"
    - name: DATABASE_URL
      value-from: "arn:aws:secretsmanager:us-east-2:442707283978:secret:deal-deck-api/database-url"
    - name: SUPABASE_DATABASE_URL
      value-from: "arn:aws:secretsmanager:us-east-2:442707283978:secret:deal-deck-api/supabase-database-url"
    - name: USE_SUPABASE
      value: "true"